#!/usr/bin/bash

rdh_root="$(realpath $0|xargs dirname)/.."
source ${rdh_root}/activate

# expose self
bin_dir=$(realpath $0|xargs dirname)

# import tools
source docker-helper
source s-config

# Usage helper
usage() {
    cat << EOF
Usage: $(basename $0) [-p port] [-s] [-b] [-r] [-h]

Start SHISA Docker container and optionally run setup or debug server.

Options:
  -p PORT    Host port to map to container's 9339 (default: 9346)
  -s         Run s-setup instead of entering container
  -b         Build hipBLASLt and commit to image
  -r         Run ShisaToolsServer.Linux64 (remote debug server)
  -h         Show this help message and exit

Examples:
  $(basename $0)              Enter container with port 9346 (default)
  $(basename $0) -p 9339      Enter container with port 9339
  $(basename $0) -s           Run setup with port 9346
  $(basename $0) -b           Build hipBLASLt and save to image
  $(basename $0) -r           Run SHISA Tools Server with port 9346
  $(basename $0) -p 9338 -r   Run SHISA Tools Server with port 9338

EOF
}

# Parse arguments using getopts
host_port=9346
run_setup=0
run_server=0
build_hipblaslt=0

while getopts "p:sbrh" opt; do
    case $opt in
        p)
            host_port=$OPTARG
            if ! [[ "$host_port" =~ ^[0-9]+$ ]]; then
                die "Invalid port: $host_port (must be numeric)"
            fi
            ;;
        s)
            run_setup=1
            ;;
        b)
            build_hipblaslt=1
            ;;
        r)
            run_server=1
            ;;
        h)
            usage
            exit 0
            ;;
        \?)
            usage
            die "Invalid option: -$OPTARG"
            ;;
        :)
            usage
            die "Option -$OPTARG requires an argument"
            ;;
    esac
done

# Validate: can't run multiple modes at once
modes_count=$(( run_setup + run_server + build_hipblaslt ))
if (( modes_count > 1 )); then
    die "Cannot specify multiple modes (-s, -b, -r) at the same time"
fi

# run at host
if is_inside_docker; then
    die "fail: cannot run inside docker!"
fi

# close old instance
close_container "$instance_name"

#        `-e SHISA_HSA_PM4_MODE=1 `
#        `-e SHISA_HSA_TIMEOUT_SECONDS=1 `
#        `-e LD_LIBRARY_PATH=/SHISA/bin-hip-6.5/:/SHISA/bin:/opt/rocm/lib/llvm/lib `

# launch shisa in background
work_dir=$(realpath "${HOME}/work")
if ! docker run -it `
        `--detach `
        `-v ${work_dir}/shisa:/SHISA/. `
        `-v ${HOME}:${HOME} `
        `-v ${work_dir}:${work_dir} `
        `-w ${work_dir}/shisa `
        `-p 127.0.0.1:${host_port}:9339 `
        `--device=/dev/kfd `
        `--device=/dev/dri `
        `--name $instance_name `
        `--hostname $(hostname -s)/$instance_name `
        `$image_name > /dev/null; then
    die "fail to run: $image_name"
fi

# enter, run setup, build hipBLASLt, or run server
if (( run_server == 1 )); then
    # Run SHISA Tools Server
    log "Starting SHISA Tools Server on 0.0.0.0:9339 (mapped to host ${host_port})"
    if ! docker exec -it "$instance_name" /SHISA/bin/ShisaToolsServer.Linux64 0.0.0.0:9339; then
        die "fail: ShisaToolsServer.Linux64"
    fi
elif (( run_setup == 1 )); then
    # shisa setup
    if ! docker exec -it "$instance_name" bash -c "cd ../shisa;${HOME}/work/rdh/shisa/s-setup"; then
        die "fail: setup shisa"
    fi
elif (( build_hipblaslt == 1 )); then
    # Build hipBLASLt
    log "Building hipBLASLt..."
    if ! docker exec -it "$instance_name" bash -c "${HOME}/work/rdh/shisa/blt-build-code"; then
        die "fail: build hipBLASLt"
    fi
    
    # Commit the container with hipBLASLt to image
    log "Committing container to image: ${image_name}"
    if ! docker commit "$instance_name" "$image_name"; then
        die "fail: commit $instance_name to $image_name"
    fi
    log "$(format_msg 'âœ“ Successfully built hipBLASLt and saved to image')"
else
    # default: enter docker
    if ! docker exec -it "$instance_name" bash; then
        die "fail: exec $instance_name"
    fi
fi

close_container "$instance_name"