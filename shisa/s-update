#!/usr/bin/bash
# SHISA Update Script
# Unpacks SHISA from tar.gz (full or binaries-only)
#
# Usage:
#   s-update [tarball]
#   Default: ~/work/shisa_src.tar.gz (full mode)
#   For binaries: ~/work/shisa_binaries.tar.gz (extracts to P4 workspace)

# expose rdh
rdh_root="$(realpath $0|xargs dirname)/.."
source ${rdh_root}/activate

# expose self
bin_dir=$(realpath $0|xargs dirname)
SELF_TAG="[$(basename $0)]"

# import tools
source docker-helper
source s-config

function update_shisa() {
    # Step 1: Unpack SHISA source
    log "1. ++++++++++++++++++++ unpack shisa src +++++++++++++++++"
    local src_file="$1"
    
    if [[ ! -f "$src_file" ]]; then
        die "Tarball not found: $src_file"
    fi
    
    local target="$(dirname "$(realpath "$src_file")")"/shisa
    if ! s-unpack-src "$src_file" "$target"; then
        die "Failed to unpack $src_file"
    fi
    log "âœ“ Unpacked successfully"
    
    # Step 2: SHISA setup
    log "2. ++++++++++++++++++++ shisa update +++++++++++++++++"
        if ! s-open -s; then
        die "fail: s-open setup shisa docker"
        fi
    log "2. ++++++++++++++++++++ shisa setup: sucess +++++++++++++++++"
    
    log "SHISA update completed successfully!"
    return 0
}

# run at host
if is_inside_docker; then
    die "fail: cannot run inside docker!"
fi

# Default tarball
DEFAULT_TARBALL="$HOME/work/shisa_src.tar.gz"
update_shisa "${1:-$DEFAULT_TARBALL}"

