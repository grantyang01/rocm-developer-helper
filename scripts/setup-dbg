#!/bin/bash
# Setup debugging configuration from rdh repo
# Creates symlinks for .gdbinit and .vscode/launch.json

# Enable rdh
rdh_root="$(realpath ${BASH_SOURCE[0]}|xargs dirname)/.."

# Expose self
SELF_TAG="[$(basename ${BASH_SOURCE[0]})]"

source tools

# Setup .gdbinit
setup_gdbinit() {
    local source="${rdh_root}/config/gdbinit"
    local target="${HOME}/.gdbinit"
    
    if [[ ! -f "$source" ]]; then
        log "Error: Source file not found: $source"
        return 1
    fi
    
    # Check if target already exists
    if [[ -L "$target" ]]; then
        local current_link=$(readlink "$target")
        if [[ "$current_link" == "$source" ]]; then
            log "✓ .gdbinit symlink already correct"
            return 0
        else
            log "⚠ .gdbinit is a symlink to: $current_link"
            log "  Updating to point to: $source"
            rm "$target"
        fi
    elif [[ -f "$target" ]]; then
        log "⚠ .gdbinit exists as a regular file"
        log "  Backing up to: ${target}.bak"
        mv "$target" "${target}.bak"
    fi
    
    # Create symlink
    ln -s "$source" "$target"
    
    if [[ -L "$target" ]]; then
        log "✓ Created .gdbinit symlink: $target -> $source"
        return 0
    else
        log "Error: Failed to create symlink"
        return 1
    fi
}

# Setup VSCode launch.json (workspace-wide at C:\work\.vscode)
setup_vscode_launch() {
    local source="${rdh_root}/config/launch.json"
    local vscode_dir="${rdh_root}/../.vscode"
    local target="${vscode_dir}/launch.json"
    
    if [[ ! -f "$source" ]]; then
        log "  launch.json not found in rdh/config/ (skipping)"
        return 0
    fi
    
    # Create .vscode directory if needed
    if [[ ! -d "$vscode_dir" ]]; then
        mkdir -p "$vscode_dir"
        log "  Created .vscode directory"
    fi
    
    # Check if target already exists
    if [[ -L "$target" ]]; then
        local current_link=$(readlink "$target")
        if [[ "$current_link" == "$source" ]]; then
            log "✓ launch.json symlink already correct"
            return 0
        else
            log "⚠ launch.json is a symlink to: $current_link"
            log "  Updating to point to: $source"
            rm "$target"
        fi
    elif [[ -f "$target" ]]; then
        log "⚠ launch.json exists as a regular file"
        log "  Backing up to: ${target}.bak"
        mv "$target" "${target}.bak"
    fi
    
    # Create symlink
    ln -s "$source" "$target"
    
    if [[ -L "$target" ]]; then
        log "✓ Created launch.json symlink: $target -> $source"
        return 0
    else
        log "Error: Failed to create symlink"
        return 1
    fi
}

log "Setting up debug configs from rdh..."
echo ""

setup_gdbinit
setup_vscode_launch

echo ""
log "✓ Setup complete!"
log "  ~/.gdbinit → rdh/config/gdbinit"
log "  C:/work/.vscode/launch.json → rdh/config/launch.json"
log "  Edit files in rdh/config/ to update configurations"

